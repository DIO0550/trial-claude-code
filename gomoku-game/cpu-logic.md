# CPU Logic Specification (CPUロジック仕様書)

## 概要

五目並べゲームにおける5段階のCPU難易度別の戦略仕様を定義します。各難易度は異なるアルゴリズムと思考レベルを持ち、プレイヤーに段階的な挑戦を提供します。

**🎯 重要な改善方針**:
- **対戦感の向上**: 全難易度でプレイヤーの石の近くに配置し、自然な対戦感を演出
- **初手CPU対応**: CPU先手時は中央付近に配置し、適切なゲーム開始を保証

## 難易度レベル構成

| 難易度 | レベル名 | 説明 | 実装状況 |
|--------|----------|------|----------|
| beginner | 入門 | ほぼランダム配置 | ✅ 実装済み |
| easy | やさしい | 基本的な防御重視 | ✅ 実装済み |
| medium | ふつう | 攻撃と防御のバランス | ❌ 未実装 |
| hard | むずかしい | 攻撃重視・3手先読み | ❌ 未実装 |
| expert | エキスパート | 最高レベル・5手先読み | ❌ 未実装 |

## 各難易度の詳細仕様

### 1. Beginner（入門）

**戦略コンセプト**: 近接優先ランダム + 初手中央配置
- **思考時間**: なし
- **探索深度**: 0手先
- **戦略優先順位**:
  1. **初手時**: 中央付近（7±2の範囲）からランダム選択
  2. **通常時**: プレイヤーの石から2マス以内を優先してランダム選択
  3. **フォールバック**: 近接範囲に空きがない場合は全盤面からランダム
- **特徴**: 初心者が勝ちやすく、かつ自然な対戦感を提供

**実装アルゴリズム**:
```
1. 盤面チェック: 初手（空盤面）かどうか判定
2. 初手の場合: 中央付近（7±2）の空き位置からランダム選択
3. 通常の場合:
   a. プレイヤーの石の位置を取得
   b. プレイヤーの石から2マス以内の空き位置を取得
   c. 近接位置が存在すればランダム選択
   d. なければ全空き位置からランダム選択
```

### 2. Easy（やさしい）

**戦略コンセプト**: 基本防御 + 追跡配置 + 初手中央配置
- **思考時間**: 短い（瞬時）
- **探索深度**: 1手先（即座の脅威のみ）
- **戦略優先順位**:
  1. **初手時**: 中央付近（7±2の範囲）からランダム選択
  2. **自分の勝利**: 4連続→5連続の勝利手
  3. **相手の阻止**: 相手4連続を防ぐ防御手
  4. **追跡配置**: プレイヤーの石から2-3マス以内を優先
  5. **フォールバック**: 全盤面からランダム配置

**実装アルゴリズム**:
```
1. 初手判定: 空盤面なら中央付近（7±2）からランダム選択
2. 勝利判定: 自分が4連続なら5連続にする手を打つ
3. 防御判定: 相手が4連続なら阻止する手を打つ
4. 追跡戦略: プレイヤーの石から2-3マス以内の空き位置を取得
5. 追跡位置が存在すればランダム選択、なければ全盤面からランダム
```

### 3. Medium（ふつう）【実装済み → Normal】

**戦略コンセプト**: バランス型 + パターン認識 + 近接重視評価
- **思考時間**: 中程度（0.5秒程度）  
- **探索深度**: 2手先読み
- **戦略要素**:
  - **初手対応**: 中央付近配置
  - **近接評価**: プレイヤーの石周辺を重点評価
  - 3連続の形成・阻止
  - 2連続の延長
  - フォーク（分岐攻撃）の基本形
  - 序盤の定石配置

**実装アルゴリズム**:
```
1. 初手判定: 空盤面なら中央付近（7±2）を高評価
2. 即座勝利・防御（Easy同様）
3. ミニマックス法（2手先読み）による位置評価
4. 評価関数に近接ボーナス追加:
   - プレイヤーの石から距離3以内: +20〜60点
   - 最新手から距離2以内: +40点追加
5. 3連続脅威の処理（作る・阻止）
6. フォーク狙い（複数の3連続候補）
7. 2連続の延長
8. 序盤定石（星・連星配置）
```

**評価項目**:
- **近接ボーナス**: プレイヤーの石との距離による加点
- 連続数による得点（2連:10点、3連:100点、4連:1000点）
- 空きスペースの多さ  
- 中央からの距離

### 4. Hard（むずかしい）【実装済み】

**戦略コンセプト**: 攻撃重視 + 3手先読み + 高度近接戦略
- **思考時間**: 長め（1-2秒）
- **探索深度**: 3手先読み
- **戦略要素**:
  - **初手対応**: 中央付近最適配置
  - **高度近接評価**: プレイヤーの戦略を予測した近接配置
  - 複雑なフォーク攻撃
  - 必勝パターンの認識
  - 相手の戦略予測
  - 高度な序盤定石

**実装アルゴリズム**:
```
1. 初手判定: 空盤面なら中央付近（7±2）を最高評価
2. ミニマックス法（3手先）+ アルファベータ枝刈り
3. 評価関数に戦略的近接ボーナス:
   - プレイヤーの石から距離2以内: +50〜100点
   - プレイヤーの連続形成を阻害する位置: +80点
   - フォーク形成可能位置での近接: +120点
4. 複合脅威の評価
5. フォーク攻撃検出・実行
6. 必勝パターン辞書
7. 序盤定石データベース
```

**評価関数**:
- **戦略的近接評価**: プレイヤーの意図を予測した近接配置
- 攻撃的評価（自分の連続を重視）
- 位置価値（戦略的要所）
- パターンマッチング（定跡・必勝形）

### 5. Expert（エキスパート）【実装済み】

**戦略コンセプト**: 最高難易度 + 5手先読み + 完璧近接戦略
- **思考時間**: 最長（3-5秒）
- **探索深度**: 5手先読み
- **戦略要素**:
  - **初手対応**: 中央付近完璧配置
  - **完璧近接戦略**: プレイヤーの全戦略を予測した最適近接配置
  - 完全戦略計算
  - 終盤完全読み
  - 高度な序盤理論
  - 人間レベルの戦略

**実装アルゴリズム**:
```
1. 初手判定: 空盤面なら中央付近（7±2）を完璧評価
2. 高度なミニマックス（5手先）+ 最適化
3. 評価関数に完璧近接戦略:
   - プレイヤーの石から距離1-2以内: +100〜200点
   - プレイヤーの全連続パターンを予測した阻害位置: +150点
   - 複数フォーク形成での戦略的近接: +250点
   - 終盤での必勝近接配置: +300点
4. 置換表による高速化
5. 反復深化探索
6. 終盤完全解析（残り手数少ない時）
7. オープニングブック（序盤定石集）
8. パターン認識エンジン
```

**高度な機能**:
- **完璧近接戦略**: 対戦感を保ちながら最高レベルの強さを実現
- 勝率計算
- 最善手確率表示
- 複数候補手の評価値表示

## 共通実装要素

### 対戦感向上のための共通機能
- **初手判定**: 空盤面（初手）の検出
- **中央配置**: 中央付近（7±2）の空き位置取得
- **近接検出**: プレイヤーの石から指定距離内の空き位置取得
- **相手色判定**: CPUと相手プレイヤーの色を判別

### 基本判定機能
- **勝利判定**: 5連続検出（4方向）
- **脅威判定**: N連続検出（N=2,3,4）
- **配置可能判定**: 空位置確認

### ユーティリティ関数
- **方向ベクトル**: `[(1,0), (0,1), (1,1), (1,-1)]`
- **連続カウント**: 指定方向の連続石数計算
- **空きスペース**: 連続可能な空位置検出
- **近接ボーナス**: 距離に応じた評価値加算

### パフォーマンス考慮
- **位置キャッシュ**: 評価済み位置の記録
- **計算時間制限**: 各難易度の思考時間上限
- **メモリ最適化**: 不要なデータの解放

## 実装優先順位（対戦感向上版）

### 🎯 **対戦感向上の実装順序**
1. **Beginner**: 近接優先ランダム + 初手中央配置
2. **Easy**: 追跡配置戦略 + 初手中央配置  
3. **Normal**: 評価関数への近接ボーナス追加
4. **Hard**: 戦略的近接評価の実装
5. **Expert**: 完璧近接戦略の実装

### 🎮 **対戦感の実現目標**
- **自然な対戦感**: プレイヤーの石の近くに配置することで、実際に対戦している感覚を提供
- **初手の適切性**: CPU先手時は中央付近から開始し、ゲームの自然な流れを作る
- **段階的な近接戦略**: 難易度が上がるほど戦略的になりつつも、常に対戦感を維持
- **バランスの維持**: 強さと対戦感の両立を実現

各段階で十分なテストとバランス調整を行い、プレイヤーが段階的にスキルアップできるような難易度曲線を実現します。

## テスト要件

各難易度について以下のテストを実装:
- **対戦感テスト**: 初手中央配置、近接配置の動作確認
- **戦略テスト**: 特定局面での期待手の確認
- **性能テスト**: 思考時間の制限内での動作確認
- **回帰テスト**: アップデート時の動作保証  
- **バランステスト**: 人間プレイヤーとの勝率測定
- **近接度テスト**: プレイヤーの石からの平均距離測定